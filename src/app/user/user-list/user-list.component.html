<div class="container my-5">
  <!-- Filters -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>User List</h2>

    <!-- Status -->
    <div class="mb-3">
      <label class="me-2 fw-bold">Status:</label>
      <div class="form-check form-check-inline" *ngFor="let s of statusOptions">
        <input
          class="form-check-input"
          type="radio"
          name="statusFilter"
          [id]="s.value + 'Status'"
          [value]="s.value"
          [(ngModel)]="statusFilter"
          (change)="onStatusChange()"
          [disabled]="isBulkUpdate"
        />
        <label class="form-check-label" [for]="s.value + 'Status'">
          {{ s.label | titlecase }}
        </label>
      </div>
    </div>

    <!-- Role -->
    <div class="mb-3 d-flex align-items-center">
      <label class="ms-3 me-2 fw-bold">Role:</label>
      <select
        class="form-select d-inline-block w-auto"
        [(ngModel)]="roleFilter"
        (change)="onRoleChange()"
        [disabled]="isBulkUpdate"
      >
        <option [ngValue]="'all'">All</option>
        <option *ngFor="let role of roleOptions" [ngValue]="role">
          {{ getRoleName(role) }}
        </option>
      </select>
    </div>

    <button class="btn btn-warning" (click)="onBulkUpdateUsers(displayedUsers)">
      Bulk Update
    </button>
    <button
      class="btn btn-success"
      (click)="onAddUser()"
      [disabled]="isBulkUpdate"
    >
      Add User
    </button>
  </div>

  <!-- Search -->
  <div class="mb-3">
    <input
      type="text"
      class="form-control"
      placeholder="Search by name, email or phone..."
      [(ngModel)]="searchTerm"
      (ngModelChange)="onSearchChange($event)"
      [disabled]="isBulkUpdate"
    />
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Age</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Address</th>
          <th>Registered Date</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody *ngIf="!isBulkUpdate">
        <ng-container *ngFor="let user of displayedUsers; let i = index">
          <ng-container
            *ngIf="inlineEditUserId === user.id"
            [formGroup]="inlineEditForm"
          >
            <tr>
              <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="name"
                />
              </td>
              <td>
                <input
                  type="number"
                  class="form-control form-control-sm"
                  formControlName="age"
                />
              </td>
              <td>
                <input
                  type="email"
                  class="form-control form-control-sm"
                  formControlName="email"
                />
              </td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="phone"
                />
              </td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="address"
                />
              </td>
              <td>
                <input
                  type="date"
                  class="form-control form-control-sm"
                  formControlName="registeredDate"
                />
              </td>
              <td>
                <select
                  class="form-select form-select-sm"
                  formControlName="role"
                >
                  <option *ngFor="let role of roleOptions" [value]="role">
                    {{ getRoleName(role) }}
                  </option>
                </select>
              </td>
              <td>
                <select
                  class="form-select form-select-sm"
                  formControlName="isActive"
                >
                  <option [ngValue]="true">Active</option>
                  <option [ngValue]="false">Inactive</option>
                </select>
              </td>
              <td>
                <button
                  class="btn btn-success btn-sm me-1"
                  (click)="onSaveInlineEdit(user)"
                >
                  Save
                </button>
                <button
                  class="btn btn-secondary btn-sm"
                  (click)="onCancelInlineEdit()"
                >
                  Cancel
                </button>
              </td>
            </tr>
            <!-- <tr>
              <td></td>
              <td colspan="8">
                <div formArrayName="children">
                  <div
                    *ngFor="let child of inlineChildren.controls; let j = index"
                    [formGroupName]="j"
                    class="d-flex mb-2"
                  >
                    <input
                      type="text"
                      formControlName="column"
                      placeholder="Column Name"
                      class="form-control me-2"
                    />
                    <input
                      type="text"
                      formControlName="value"
                      placeholder="Value"
                      class="form-control me-2"
                    />
                    <button
                      type="button"
                      class="btn btn-danger btn-sm"
                      (click)="removeInlineChild(j)"
                    >
                      X
                    </button>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-info btn-sm"
                  (click)="addInlineChild()"
                >
                  + Add Column
                </button>
              </td>
              <td></td>
            </tr> -->
          </ng-container>

          <tr *ngIf="inlineEditUserId !== user.id">
            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.age }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phone }}</td>
            <td>{{ user.address }}</td>
            <td>{{ user.registeredDate }}</td>
            <td>
              <span class="badge" [ngClass]="getRoleClass(user.role)">
                {{ getRoleName(user.role) }}
              </span>
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="user.isActive ? 'bg-success' : 'bg-danger'"
              >
                {{ user.isActive ? "Active" : "Inactive" }}
              </span>
            </td>
            <td>
              <button
                class="btn btn-primary btn-sm me-1"
                (click)="onEditUser(user)"
                *ngIf="user.isActive"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-sm"
                (click)="onDeleteUser(user)"
                *ngIf="!user.isActive"
              >
                Delete
              </button>
              <button
                class="btn btn-secondary btn-sm me-1"
                (click)="onToggleStatus(user)"
              >
                {{ user.isActive ? "Inactive" : "Active" }}
              </button>
              <button
                class="btn btn-warning btn-sm"
                (click)="onInlineEdit(user)"
              >
                Inline Edit
              </button>
              <button class="btn btn-info btn-sm" (click)="onAddColumn(user)">
                Add Column
              </button>
            </td>
          </tr>

          <!-- Extra rows for dynamic columns -->
          <ng-container *ngIf="user.children && user.children.length > 0">
            <tr *ngFor="let chunk of chunkChildren(user.children, 8)">
              <td></td>
              <td *ngFor="let child of chunk">
                <strong>{{ child.column }}:</strong> {{ child.value }}
              </td>
              <td *ngFor="let empty of [].constructor(8 - chunk.length)"></td>
              <td></td>
            </tr>
          </ng-container>

          <tr *ngIf="addColumnUserId === user.id" [formGroup]="addColumnForm">
            <td></td>
            <td colspan="9">
              <div class="d-flex">
                <input
                  type="text"
                  placeholder="Column Name"
                  class="form-control me-2"
                  formControlName="column"
                />
                <input
                  type="text"
                  placeholder="Value"
                  class="form-control me-2"
                  formControlName="value"
                />
                <button
                  class="btn btn-success me-2"
                  (click)="onSaveColumn(user)"
                >
                  Save
                </button>
                <button class="btn btn-secondary" (click)="onCancelColumn()">
                  Cancel
                </button>
              </div>
            </td>
          </tr>
        </ng-container>
        <tr *ngIf="displayedUsers.length === 0">
          <td colspan="10" class="text-center">No users found.</td>
        </tr>
      </tbody>

      <tbody *ngIf="isBulkUpdate" [formGroup]="bulkForm">
        <ng-container formArrayName="users">
          <ng-container
            *ngFor="let group of bulkFormArray.controls; let i = index"
            [formGroupName]="i"
          >
            <tr>
              <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="name"
                />
              </td>
              <td>
                <input
                  type="number"
                  class="form-control form-control-sm"
                  formControlName="age"
                />
              </td>
              <td>
                <input
                  type="email"
                  class="form-control form-control-sm"
                  formControlName="email"
                />
              </td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="phone"
                />
              </td>
              <td>
                <input
                  class="form-control form-control-sm"
                  formControlName="address"
                />
              </td>
              <td>
                <input
                  type="date"
                  class="form-control form-control-sm"
                  formControlName="registeredDate"
                />
              </td>
              <td>
                <select
                  class="form-select form-select-sm"
                  formControlName="role"
                >
                  <option *ngFor="let role of roleOptions" [value]="role">
                    {{ getRoleName(role) }}
                  </option>
                </select>
              </td>
              <td>
                <select
                  class="form-select form-select-sm"
                  formControlName="isActive"
                >
                  <option [ngValue]="true">Active</option>
                  <option [ngValue]="false">Inactive</option>
                </select>
              </td>
              <td></td>
            </tr>
            <!-- <tr>
              <td></td>
              <td colspan="8">
                <div formArrayName="children">
                  <div
                    *ngFor="
                      let child of getChildrenControls(group);
                      let j = index
                    "
                    [formGroupName]="j"
                    class="d-flex mb-2"
                  >
                    <input
                      type="text"
                      formControlName="column"
                      placeholder="Column Name"
                      class="form-control me-2"
                    />
                    <input
                      type="text"
                      formControlName="value"
                      placeholder="Value"
                      class="form-control me-2"
                    />
                    <button
                      type="button"
                      class="btn btn-danger btn-sm"
                      (click)="removeBulkChild(i, j)"
                    >
                      X
                    </button>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-info btn-sm"
                  (click)="addBulkChild(i)"
                >
                  + Add Column
                </button>
              </td>
              <td></td>
            </tr> -->
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>
  <div *ngIf="isBulkUpdate" class="mt-3">
    <button class="btn btn-success me-2" (click)="onSaveBulkUpdate()">
      Save All
    </button>
    <button class="btn btn-secondary" (click)="onCancelBulkUpdate()">
      Cancel
    </button>
  </div>

  <!-- Pagination -->
  <app-pagination
    [totalItems]="totalUsers"
    [itemsPerPage]="itemsPerPage"
    [currentPage]="currentPage"
    [isDisabled]="isBulkUpdate"
    (pageChange)="onPaginationChange($event)"
  ></app-pagination>
</div>
